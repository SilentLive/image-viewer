!function(a){"use strict";function b(b,c,d){function e(a){return V===U[a]}function f(a){if(a.length<1)return new r;for(var b=o(a[0].x,a[0].y),c=b,d=null,e=1;e<a.length;e++){if(d=o(a[e].x,a[e].y),d.equals(b)){c.next=b;break}c.next=d,c=d}return new r(b)}function g(a){if("undefined"==typeof a||null===a)return[];var b=[],c=a.getVertices();c[c.length-1].next===c[0]&&c.push(c[0]);for(var d=0;d<c.length;d++)b.push({x:c[d].position.x,y:c[d].position.y});return b}function h(){Q=M.height/L.image.height*L.image.width<=M.width?M.height/L.image.height:M.width/L.image.width,S.x=L.image.width/2,S.y=L.image.height/2,O=!0,i()}function i(){if(O){O=!1;var b=N;b.clearRect(0,0,M.width,M.height),b.save();var c=M.width/2-S.x*Q,d=M.height/2-S.y*Q;if(b.translate(c,d),b.scale(Q,Q),b.drawImage(L.image,0,0),b.restore(),wb&&null!==L.solution&&s(b,L.solution),yb&&L.annotations.forEach(function(a){s(b,a.polygon,a.color)}),(vb||xb)&&null!==sb&&sb.getLength()>0&&!sb.isClosed()){var e=sb.getLastVertex().position,f=m(qb);j(b,e,f,"#FF3300",T)}ub&&null!==L.answer&&x(b),k(b)}P||a.requestAnimationFrame(i)}function j(a,b,c,d,e){a.save(),a.strokeStyle=d,a.lineWidth=e;var f=n(b),g={x:c.x-b.x,y:c.y-b.y},h={x:0,y:0};a.translate(f.x,f.y),a.scale(Q,Q),a.beginPath(),a.moveTo(h.x,h.y),a.lineTo(g.x,g.y),a.stroke(),a.restore()}function k(a){for(var b=10,c=20,d=2*c+b,e=M.width-c-b,f=M.height-c-b,g=0;g<mb.length;g++)mb[g].draw(a,e,f-d*g,c);if(null!==nb){a.save(),a.globalAlpha=.5;var h=c;a.font=h+"px sans-serif";var i=a.measureText(nb).width,j=i+b,k=.7*h+b,m=M.width-(2*c+2*b)-j,n=M.height-k-b,o=m+.5*b,p=M.height-1.5*b;a.fillStyle="#000000",l(a,m,n,j,k,8,!0,!1),a.fillStyle="#ffffff",a.fillText(nb,o,p),a.restore()}}function l(a,b,c,d,e,f,g,h){f="number"==typeof f?f:5,g="boolean"==typeof g?g:!0,h="boolean"==typeof h?h:!1,a.beginPath(),a.moveTo(b+f,c),a.lineTo(b+d-f,c),a.quadraticCurveTo(b+d,c,b+d,c+f),a.lineTo(b+d,c+e-f),a.quadraticCurveTo(b+d,c+e,b+d-f,c+e),a.lineTo(b+f,c+e),a.quadraticCurveTo(b,c+e,b,c+e-f),a.lineTo(b,c+f),a.quadraticCurveTo(b,c,b+f,c),a.closePath(),g&&a.fill(),h&&a.stroke()}function m(a){var b={x:S.x>=M.width/Q/2?S.x-M.width/Q/2:0,y:S.y>=M.height/Q/2?S.y-M.height/Q/2:0},c={x:S.x>=M.width/Q/2?0:M.width/2-S.x*Q,y:S.y>=M.height/Q/2?0:M.height/2-S.y*Q},d={};return d.x=b.x+a.x/Q-c.x/Q,d.y=b.y+a.y/Q-c.y/Q,d}function n(a){return{x:(a.x+M.width/Q/2-S.x)*Q,y:(a.y+M.height/Q/2-S.y)*Q}}function o(a,b,c){var d=new p(a,b,c);return d.onClick=function(){if(e("POLYGON_POINT_DELETE"))return null!==d.polygon&&(d.polygon.deleteVertex(d),d.polygon===L.solution&&L.onSolutionChange(L.exportSolution()),O=!0),!1;if(e("POLYGON_DRAW")){var a=null!==d.polygon&&d.equals(d.polygon.initialVertex);if(a&&d.polygon.getLength()>2)return d.polygon.close(),V=U.DEFAULT,d.polygon===L.solution&&L.onSolutionChange(L.exportSolution()),!1}return!0},d.onMouseDown=function(){return e("POLYGON_MOVE")?(ob=d.position,pb=!0,!0):!1},d}function p(a,b,c){this.position={x:a,y:b},this.polygon=c||null,this.next=null,this.handleWidth=12,this.onClick=function(){return!0},this.onMouseDown=function(){}}function q(a,b){a.save();var c=n(b.position);a.translate(c.x,c.y),a.fillStyle=b===rb&&b===sb.initialVertex&&e("POLYGON_DRAW")?"#FF6600":"#FFFFFF",a.strokeStyle="#000000",a.beginPath(),a.rect(-b.handleWidth/2,-b.handleWidth/2,b.handleWidth,b.handleWidth),a.stroke(),a.fill(),a.restore()}function r(a){var b=this;this.initialVertex=a||null,this.onMouseDown=function(){return!1},this.onClick=function(){return vb||xb?(sb=b,O=!0,!1):!0}}function s(a,b,c,d){if(null!==b.initialVertex&&null!==b.initialVertex.next){var e,f={x:0,y:0},g=b.initialVertex,h=n(b.initialVertex.position);a.save(),a.globalAlpha=.7,a.translate(h.x,h.y),a.scale(Q,Q),a.beginPath(),a.moveTo(f.x,f.y);do e=g.next,f={x:f.x+(e.position.x-g.position.x),y:f.y+(e.position.y-g.position.y)},a.lineTo(f.x,f.y),g=e;while(null!==g.next&&g!==b.initialVertex);a.fillStyle=c||"#0000FF",a.strokeStyle=d||"#66FF33",g===b.initialVertex&&(a.strokeStyle=d||"#000000",a.closePath(),a.fill()),a.lineWidth=T,a.stroke(),a.restore()}b===sb&&(vb||xb)&&b.getVertices().forEach(function(b){q(a,b)})}function t(a,b,c){return(b.x-a.x)*(c.y-a.y)-(c.x-a.x)*(b.y-a.y)}function u(a,b){var c={polygon:a||new r,color:b||zb[(L.annotations.length+1)%zb.length]};return L.annotations.push(c),c}function v(){L.annotations=L.annotations.filter(function(a){return"object"==typeof a.polygon&&"undefined"!=typeof a.polygon.isClosed?a.polygon.isClosed():!1})}function w(){var a="#0000ff";if(wb){var b=n(L.answer);a=null!==L.solution&&L.solution.isWithinBounds(b.x,b.y)?"#00ff00":"#ff0000"}return a}function x(a){a.save();var b=1.5,c=n(L.answer);a.translate(c.x,c.y),a.scale(b*Q,b*Q),a.shadowColor="#ffffff",a.shadowBlur=5,G(a,"",w(),0,0,50),a.restore()}function y(){var a=[];return a=a.concat(mb),(vb||xb)&&null!==sb&&(a=a.concat(sb.getVertices())),a=a.concat(L.annotations.map(function(a){return a.polygon})),null!==L.solution&&a.push(L.solution),a}function z(a){var b=M.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top},d=y().filter(function(a){return a.isWithinBounds(c.x,c.y)});return d.length>0?d[0]:null}function A(a){if(0===a.button){var b=z(a);null!==b&&b.onMouseDown(a)||(pb=!0)}}function B(a){0===a.button&&(ob=S,pb=!1)}function C(a){if(0===a.button){var b=z(a);if(null===b||b.onClick(a)){var c=M.getBoundingClientRect(),d={x:a.clientX-c.left,y:a.clientY-c.top};if(e("ANSWER_DRAW"))L.answer=m(d),O=!0;else if(e("POLYGON_DRAW")){if(a.shiftKey)null!==L.solution&&(L.solution.close(),V=U.DEFAULT,L.onSolutionChange(L.exportSolution()));else{var f=m(d),g=o(f.x,f.y);if(null===sb){if(!vb)return xb?void console.log("No active polygon. Click on a polygon to edit it!"):void console.log("invalid POLYGON_DRAW state");null===L.solution&&(L.solution=new r),sb=L.solution}sb.addVertex(g)}L.onSolutionChange(L.exportSolution()),O=!0}else null!==sb&&(sb=null,O=!0)}}}function D(a){a||(a=event),a.preventDefault(),a.detail<0||a.wheelDelta>0?L.zoomOut():L.zoomIn()}function E(a){var b=M.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top};qb=qb||{x:0,y:0};var d=c.x-qb.x,e=c.y-qb.y;if(pb)ob===S?(ob.x-=d/Q,ob.y-=e/Q):(ob.x+=d/Q,ob.y+=e/Q),L.onSolutionChange(L.exportSolution()),O=!0;else{var f=z(a),g=nb;null!==f?("undefined"!=typeof f.tooltip&&(nb=f.tooltip),f!==rb&&(rb=f)):(nb=null,null!==rb&&(rb=null)),g!==nb&&(O=!0)}qb=c,(vb||xb)&&(O=!0)}function F(a,b){this.drawPosition=null,this.drawRadius=0,this.alpha=.5,this.color="#000000",this.icon=a,this.iconColor="#ffffff",this.tooltip=b||null,this.enabled=!1,this.enabledAlpha=.7,this.onClick=function(){return alert("no click action set!"),!0},this.onMouseDown=function(){return!1}}function G(a,b,c,d,e,f){a.font=f+"px FontAwesome",a.fillStyle=c;var g=a.measureText(b),h=d-g.width/2,i=e+.7*f/2;a.fillText(b,h,i)}function H(a,b,c){a.addEventListener(b,c),W.push({eventTarget:a,eventType:b,listener:c})}function I(){var a,b,c=W.slice();for(a=0;a<c.length;a++)b=c[a],b.eventTarget.removeEventListener(b.eventType,b.listener);W=[]}function J(){H(document,"mousedown",A),H(document,"mouseup",B),H(M,"DOMMouseScroll",D),H(M,"mousewheel",D),H(M,"mousemove",E),H(M,"click",C)}function K(){L.image.addEventListener("load",h,!1),L.image.src=c,"[object Array]"===Object.prototype.toString.call(d.solution)&&L.importSolution(d.solution),"[object Array]"===Object.prototype.toString.call(d.annotations)&&L.importAnnotations(d.annotations),X.onClick=function(){return L.zoomOut(),!1},Y.onClick=function(){return L.zoomIn(),!1},tb&&($.onClick=function(){return L.answer=null,O=!0,!1},_.enabled=function(){return e("ANSWER_DRAW")},_.onClick=function(){return V=e("ANSWER_DRAW")?U.DEFAULT:U.ANSWER_DRAW,O=!0,!1},mb=Z.concat(ab));var a=function(){return e("POLYGON_DRAW")},b=function(){return V=e("POLYGON_DRAW")?U.DEFAULT:U.POLYGON_DRAW,O=!0,!1},f=function(){return e("POLYGON_MOVE")},g=function(){return V=e("POLYGON_MOVE")?U.DEFAULT:U.POLYGON_MOVE,O=!0,!1},i=function(){return e("POLYGON_POINT_DELETE")},j=function(){return V=e("POLYGON_POINT_DELETE")?U.DEFAULT:U.POLYGON_POINT_DELETE,O=!0,!1};vb&&(bb.enabled=a,bb.onClick=b,cb.enabled=f,cb.onClick=g,db.enabled=i,db.onClick=j,eb.onClick=function(){return L.solution=sb=null,L.onSolutionChange(L.exportSolution()),O=!0,!1},mb=Z.concat(fb)),xb&&(gb.enabled=function(){return xb},gb.onClick=function(){v();var a=u();return sb=a.polygon,V=U.POLYGON_DRAW,!1},hb.enabled=a,hb.onClick=b,ib.enabled=f,ib.onClick=g,jb.enabled=i,jb.onClick=j,kb.onClick=function(){for(var a=-1,b=0;b<L.annotations.length;b++)if(L.annotations[b].polygon===sb){a=b;break}return a>-1?(L.annotations.splice(a,1),sb=null,O=!0,!1):!0},mb=Z.concat(lb)),J()}var L=this;d="object"==typeof d?d:{},d.mode="string"==typeof d.mode?d.mode:"";var M=document.getElementById(b),N=M.getContext("2d"),O=!0,P=!1,Q=1,R=.1,S={x:0,y:0},T=3,U={DEFAULT:0,ANSWER_DRAW:1,POLYGON_DRAW:2,POLYGON_MOVE:3,POLYGON_POINT_DELETE:4,ANNOTATION_DISPLAY:5},V=U.DEFAULT,W=[],X=new F("","Zoom out"),Y=new F("","Zoom in"),Z=[X,Y],$=new F("","Delete answer"),_=new F("","Set answer"),ab=[$,_],bb=new F("","Draw new solution point (close with shift-click)"),cb=new F("","Move solution point"),db=new F("","Delete solution point"),eb=new F("","Delete solution"),fb=[eb,db,cb,bb],gb=new F("","Start drawing a new annotation"),hb=new F("","Draw new annotation point (close with shift-click)"),ib=new F("","Move annotation point"),jb=new F("","Delete annotation point"),kb=new F("","Delete active annotation"),lb=[kb,jb,ib,hb,gb],mb=Z.slice(),nb=null,ob=S,pb=!1,qb=null,rb=null,sb=null,tb="editAnswer"===d.mode,ub=tb||"showSolution"===d.mode,vb="editSolution"===d.mode,wb=vb||"showSolution"===d.mode,xb="editAnnotations"===d.mode,yb=xb||"showAnnotations"===d.mode,zb=["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462"];this.image=new Image,this.answer="object"==typeof d.answer&&null!==d.answer?d.answer:null,this.solution=null,this.annotations=[],this.exportSolution=function(){return g(this.solution)},this.importSolution=function(a){this.solution=sb=a.length>=1?f(a):null,O=!0},this.exportAnnotations=function(){return this.annotations.map(function(a){return{color:a.color,polygon:g(a.polygon)}})},this.importAnnotations=function(a){a.forEach(function(a){u(f(a.polygon),a.color)})},this.onSolutionChange=function(){},this.onAnnotationChange=function(){},this.zoomIn=function(){Q*=1+R,O=!0},this.zoomOut=function(){Q*=1-R,O=!0},p.prototype.equals=function(a){return this.position.x===a.position.x&&this.position.y===a.position.y},p.prototype.isWithinBounds=function(a,b){var c=n(this.position);return a>=c.x-this.handleWidth/2&&a<=c.x+this.handleWidth/2&&b>=c.y-this.handleWidth/2&&b<=c.y+this.handleWidth/2},r.prototype.addVertex=function(a){if(null!==this.initialVertex){for(var b=this.initialVertex;null!==b.next&&b.next!==this.initialVertex;)b=b.next;b.next=a}else this.initialVertex=a;a.polygon=this,O=!0},r.prototype.deleteVertex=function(a){if(null!==this.initialVertex&&this.initialVertex.equals(a))this.initialVertex=this.initialVertex.next;else for(var b=!1,c=this.initialVertex,d=c.next;!b&&null!==d&&d!==this.initialVertex;)d.equals(a)?(c.next=d.next,b=!0):(c=d,d=c.next)},r.prototype.getVertices=function(){for(var a=[],b=this.initialVertex;null!==b;)-1===a.indexOf(b)&&a.push(b),b=b.next!==this.initialVertex?b.next:null;return a},r.prototype.isClosed=function(){var a=this.initialVertex;if(null===a)return!1;for(;null!==a.next&&a.next!==this.initialVertex;)a=a.next;return a.next===this.initialVertex},r.prototype.getLastVertex=function(){var a=this.initialVertex;if(null===a)return null;for(;null!==a.next&&a.next!==this.initialVertex;)a=a.next;return a},r.prototype.getLength=function(){if(null===this.initialVertex)return 0;for(var a=1,b=this.initialVertex;null!==b.next&&b.next!==this.initialVertex;)b=b.next,a++;return a},r.prototype.isWithinBounds=function(a,b){var c=this.getVertices(),d=0,e=m({x:a,y:b});if(c.length<3||c[c.length-1].next!==c[0])return!1;c.push(c[0]);for(var f=0;f+1<c.length;f++)c[f].position.y<=e.y?c[f+1].position.y>e.y&&t(c[f].position,c[f+1].position,e)>0&&d++:c[f+1].position.y<=e.y&&t(c[f].position,c[f+1].position,e)<0&&d--;return 0!==d},r.prototype.close=function(){this.getVertices().length>2&&this.addVertex(this.initialVertex)},F.prototype.isWithinBounds=function(a,b){if(null===this.drawPosition)return!1;var c=Math.abs(this.drawPosition.x-a),d=Math.abs(this.drawPosition.y-b);return c*c+d*d<=this.drawRadius*this.drawRadius},F.prototype.draw=function(a,b,c,d){this.drawPosition={x:b,y:c},this.drawRadius=d,a.save();var e="function"==typeof this.enabled?this.enabled():this.enabled;a.globalAlpha=e?this.enabledAlpha:this.alpha,a.fillStyle=this.color,a.lineWidth=0,a.beginPath(),a.arc(b,c,d,0,2*Math.PI),a.closePath(),a.fill(),a.save(),a.globalCompositeOperation="destination-out",G(a,this.icon,this.iconColor,b,c,d),a.restore(),a.restore()},this.dispose=function(){I(),P=!0},this.refresh=function(){L.dirty=!0},K()}a.ImageViewer=b}(window);