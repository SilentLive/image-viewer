!function(a){"use strict";function b(b,c,d){function e(){H=D.height/C.image.height*C.image.width<=D.width?D.height/C.image.height:D.width/C.image.width,J.x=C.image.width/2,J.y=C.image.height/2,F=!0,f()}function f(){if(F){F=!1;var b=E;b.clearRect(0,0,D.width,D.height),b.save();var c=D.width/2-J.x*H,d=D.height/2-J.y*H;b.translate(c,d),b.scale(H,H),b.drawImage(C.image,0,0),b.restore(),g(b),eb&&null!==C.solution&&C.solution.draw(b),cb&&null!==C.answer&&o(b)}G||a.requestAnimationFrame(f)}function g(a){for(var b=10,c=20,d=2*c+b,e=D.width-c-b,f=D.height-c-b,g=0;g<Y.length;g++)Y[g].draw(a,e,f-d*g,c);if(null!==Z){a.save(),a.globalAlpha=.5;var i=c;a.font=i+"px sans-serif";var j=a.measureText(Z).width,k=j+b,l=.7*i+b,m=D.width-(2*c+2*b)-k,n=D.height-l-b,o=m+.5*b,p=D.height-1.5*b;a.fillStyle="#000000",h(a,m,n,k,l,8,!0,!1),a.fillStyle="#ffffff",a.fillText(Z,o,p),a.restore()}}function h(a,b,c,d,e,f,g,h){f="number"==typeof f?f:5,g="boolean"==typeof g?g:!0,h="boolean"==typeof h?h:!1,a.beginPath(),a.moveTo(b+f,c),a.lineTo(b+d-f,c),a.quadraticCurveTo(b+d,c,b+d,c+f),a.lineTo(b+d,c+e-f),a.quadraticCurveTo(b+d,c+e,b+d-f,c+e),a.lineTo(b+f,c+e),a.quadraticCurveTo(b,c+e,b,c+e-f),a.lineTo(b,c+f),a.quadraticCurveTo(b,c,b+f,c),a.closePath(),g&&a.fill(),h&&a.stroke()}function i(a){var b={x:J.x>=D.width/H/2?J.x-D.width/H/2:0,y:J.y>=D.height/H/2?J.y-D.height/H/2:0},c={x:J.x>=D.width/H/2?0:D.width/2-J.x*H,y:J.y>=D.height/H/2?0:D.height/2-J.y*H},d={};return d.x=b.x+a.x/H-c.x/H,d.y=b.y+a.y/H-c.y/H,d}function j(a){return{x:(a.x+D.width/H/2-J.x)*H,y:(a.y+D.height/H/2-J.y)*H}}function k(a,b){var c=this,d=this.position={x:a,y:b};this.next=null,this.handleWidth=12,this.onClick=function(a){return L===K.SOLUTION_POINT_DELETE?(C.solution.deleteVertex(c),void(F=!0)):L===K.SOLUTION_DRAW&&a.shiftKey&&null!==C.solution&&c.equals(C.solution.initialVertex)?(C.solution.close(),void(L=K.DEFAULT)):void 0},this.onMouseDown=function(){return L===K.SOLUTION_MOVE?($=d,_=!0,!0):!1}}function l(a){this.initialVertex=a||null}function m(a,b,c){return(b.x-a.x)*(c.y-a.y)-(c.x-a.x)*(b.y-a.y)}function n(){var a="#0000ff";return eb&&(a=null!==C.solution&&C.solution.isWithinBounds(C.answer.x,C.answer.y)?"#00ff00":"#ff0000"),a}function o(a){a.save();var b=1.5,c=j(C.answer);a.translate(c.x,c.y),a.scale(b*H,b*H),a.shadowColor="#ffffff",a.shadowBlur=5,x(a,"",n(),0,0,50),a.restore()}function p(){var a=null!==C.solution&&db?C.solution.getVertices():[];return Y.concat(a)}function q(a){var b=D.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top},d=p().filter(function(a){return a.isWithinBounds(c.x,c.y)});return d.length>0?d[0]:null}function r(a){if(0===a.button){var b=q(a);null!==b&&b.onMouseDown(a)||(_=!0)}}function s(a){0===a.button&&($=J,_=!1)}function t(a){if(0===a.button){var b=q(a);if(null!==b)b.onClick(a);else{var c=D.getBoundingClientRect(),d={x:a.clientX-c.left,y:a.clientY-c.top};if(L===K.ANSWER_DRAW&&(C.answer=i(d),F=!0),L===K.SOLUTION_DRAW){if(a.shiftKey)null!==C.solution&&(C.solution.close(),L=K.DEFAULT);else{var e=i(d),f=new k(e.x,e.y);null===C.solution&&(C.solution=new l),C.solution.addVertex(f)}F=!0}}}}function u(a){a||(a=event),a.preventDefault(),a.detail<0||a.wheelDelta>0?C.zoomOut():C.zoomIn()}function v(a){var b=D.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top};if(null!==ab&&_){var d=c.x-ab.x,e=c.y-ab.y;$===J?($.x-=d/H,$.y-=e/H):($.x+=d/H,$.y+=e/H),F=!0}else{var f=q(a),g=Z;Z=null!==f&&"undefined"!=typeof f.tooltip?f.tooltip:null,g!==Z&&(F=!0)}ab=c}function w(a,b){this.drawPosition=null,this.drawRadius=0,this.alpha=.5,this.color="#000000",this.icon=a,this.iconColor="#ffffff",this.tooltip=b||null,this.enabled=!1,this.enabledAlpha=.7,this.onClick=function(){alert("no click action set!")},this.onMouseDown=function(){return!1}}function x(a,b,c,d,e,f){a.font=f+"px FontAwesome",a.fillStyle=c;var g=a.measureText(b),h=d-g.width/2,i=e+.7*f/2;a.fillText(b,h,i)}function y(a,b,c){a.addEventListener(b,c),M.push({eventTarget:a,eventType:b,listener:c})}function z(){var a,b,c=M.slice();for(a=0;a<c.length;a++)b=c[a],b.eventTarget.removeEventListener(b.eventType,b.listener);M=[]}function A(){y(document,"mousedown",r),y(document,"mouseup",s),y(D,"DOMMouseScroll",u),y(D,"mousewheel",u),y(D,"mousemove",v),y(D,"click",t)}function B(){C.image.addEventListener("load",e,!1),C.image.src=c,"[object Array]"===Object.prototype.toString.call(d.solution)&&C.importSolution(d.solution),N.onClick=function(){C.zoomOut()},O.onClick=function(){C.zoomIn()},bb&&(Q.onClick=function(){C.answer=null,F=!0},R.enabled=function(){return L===K.ANSWER_DRAW},R.onClick=function(){L=L===K.ANSWER_DRAW?K.DEFAULT:K.ANSWER_DRAW,F=!0},Y=P.concat(S)),db&&(T.enabled=function(){return L===K.SOLUTION_DRAW},T.onClick=function(){L=L===K.SOLUTION_DRAW?K.DEFAULT:K.SOLUTION_DRAW,F=!0},U.enabled=function(){return L===K.SOLUTION_MOVE},U.onClick=function(){L=L===K.SOLUTION_MOVE?K.DEFAULT:K.SOLUTION_MOVE,F=!0},V.enabled=function(){return L===K.SOLUTION_POINT_DELETE},V.onClick=function(){L=L===K.SOLUTION_POINT_DELETE?K.DEFAULT:K.SOLUTION_POINT_DELETE,F=!0},W.onClick=function(){C.solution=null,F=!0},Y=P.concat(X)),A()}var C=this;d="object"==typeof d?d:{};var D=document.getElementById(b),E=D.getContext("2d"),F=!0,G=!1,H=1,I=.1,J={x:0,y:0},K={DEFAULT:0,ANSWER_DRAW:1,SOLUTION_DRAW:2,SOLUTION_MOVE:3,SOLUTION_POINT_DELETE:4},L=K.DEFAULT,M=[],N=new w("","Zoom out"),O=new w("","Zoom in"),P=[N,O],Q=new w("","Delete answer"),R=new w("","Set answer"),S=[Q,R],T=new w("","Draw new solution point (close with shift-click)"),U=new w("","Move solution point"),V=new w("","Delete solution point"),W=new w("","Delete solution"),X=[W,V,U,T],Y=P.slice(),Z=null,$=J,_=!1,ab=null,bb="string"==typeof d.mode&&"editAnswer"===d.mode,cb=bb||"string"==typeof d.mode&&"showSolution"===d.mode,db="string"==typeof d.mode&&"editSolution"===d.mode,eb=db||"string"==typeof d.mode&&"showSolution"===d.mode;this.image=new Image,this.answer="object"==typeof d.answer&&null!==d.answer?d.answer:null,this.solution=null,this.exportSolution=function(){if(null===this.solution)return[];var a=[],b=this.solution.getVertices();b[b.length-1].next===b[0]&&b.push(b[0]);for(var c=0;c<b.length;c++)a.push({x:b[c].position.x,y:b[c].position.y});return a},this.importSolution=function(a){if(a.length<1)return void(this.solution=null);for(var b=new k(a[0].x,a[0].y),c=b,d=null,e=1;e<a.length;e++){if(d=new k(a[e].x,a[e].y),d.equals(b)){c.next=b;break}c.next=d,c=d}this.solution=new l(b),F=!0},this.zoomIn=function(){H*=1+I,F=!0},this.zoomOut=function(){H*=1-I,F=!0},k.prototype.equals=function(a){return this.position.x===a.position.x&&this.position.y===a.position.y},k.prototype.isWithinBounds=function(a,b){var c=j(this.position);return a>=c.x-this.handleWidth/2&&a<=c.x+this.handleWidth/2&&b>=c.y-this.handleWidth/2&&b<=c.y+this.handleWidth/2},k.prototype.drawHandle=function(a){a.save();var b=j(this.position);a.translate(b.x,b.y),a.fillStyle="#FFFFFF",a.strokeStyle="#000000",a.beginPath(),a.rect(-this.handleWidth/2,-this.handleWidth/2,this.handleWidth,this.handleWidth),a.stroke(),a.fill(),a.restore()},l.prototype.addVertex=function(a){if(null!==this.initialVertex){for(var b=this.initialVertex;null!==b.next&&b.next!==this.initialVertex;)b=b.next;b.next=a}else this.initialVertex=a;F=!0},l.prototype.deleteVertex=function(a){if(null!==this.initialVertex&&this.initialVertex.equals(a))this.initialVertex=this.initialVertex.next;else for(var b=!1,c=this.initialVertex,d=c.next;!b&&null!==d&&d!==this.initialVertex;)d.equals(a)?(c.next=d.next,b=!0):(c=d,d=c.next)},l.prototype.getVertices=function(){for(var a=[],b=this.initialVertex;null!==b;)-1===a.indexOf(b)&&a.push(b),b=b.next!==this.initialVertex?b.next:null;return a},l.prototype.draw=function(a){if(null!==this.initialVertex&&null!==this.initialVertex.next){var b,c={x:0,y:0},d=this.initialVertex,e=j(this.initialVertex.position);a.save(),a.globalAlpha=.7,a.translate(e.x,e.y),a.scale(H,H),a.beginPath(),a.moveTo(c.x,c.y);do b=d.next,c={x:c.x+(b.position.x-d.position.x),y:c.y+(b.position.y-d.position.y)},a.lineTo(c.x,c.y),d=b;while(null!==d.next&&d!==this.initialVertex);a.fillStyle="#0000FF",d===this.initialVertex&&(a.closePath(),a.fill()),a.stroke(),a.restore()}db&&this.getVertices().forEach(function(b){b.drawHandle(a)})},l.prototype.isWithinBounds=function(a,b){var c=this.getVertices(),d=0,e={x:a,y:b};if(c[c.length-1].next!==c[0])return!1;for(var f=0;f+1<c.length;f++)c[f].position.y<=e.y?c[f+1].position.y>e.y&&m(c[f].position,c[f+1].position,e)>0&&d++:c[f+1].position.y<=e.y&&m(c[f].position,c[f+1].position,e)<0&&d--;return 0!==d},l.prototype.close=function(){this.getVertices().length>2&&this.addVertex(this.initialVertex)},w.prototype.isWithinBounds=function(a,b){if(null===this.drawPosition)return!1;var c=Math.abs(this.drawPosition.x-a),d=Math.abs(this.drawPosition.y-b);return c*c+d*d<=this.drawRadius*this.drawRadius},w.prototype.draw=function(a,b,c,d){this.drawPosition={x:b,y:c},this.drawRadius=d,a.save();var e="function"==typeof this.enabled?this.enabled():this.enabled;a.globalAlpha=e?this.enabledAlpha:this.alpha,a.fillStyle=this.color,a.lineWidth=0,a.beginPath(),a.arc(b,c,d,0,2*Math.PI),a.closePath(),a.fill(),a.save(),a.globalCompositeOperation="destination-out",x(a,this.icon,this.iconColor,b,c,d),a.restore(),a.restore()},this.dispose=function(){z(),G=!0},this.refresh=function(){C.dirty=!0},B()}a.ImageViewer=b}(window);