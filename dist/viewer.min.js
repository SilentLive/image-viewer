!function(a){"use strict";function b(b,c,d){function e(){G=C.height/B.image.height*B.image.width<=C.width?C.height/B.image.height:C.width/B.image.width,I.x=B.image.width/2,I.y=B.image.height/2,E=!0,f()}function f(){if(E){E=!1;var b=D;b.clearRect(0,0,C.width,C.height),b.save();var c=C.width/2-I.x*G,d=C.height/2-I.y*G;b.translate(c,d),b.scale(G,G),b.drawImage(B.image,0,0),b.restore(),g(b),db&&null!==B.solution&&B.solution.draw(b),bb&&null!==B.target&&n(b)}F||a.requestAnimationFrame(f)}function g(a){for(var b=10,c=20,d=2*c+b,e=C.width-c-b,f=C.height-c-b,g=0;g<X.length;g++)X[g].draw(a,e,f-d*g,c);if(null!==Y){a.save(),a.globalAlpha=.5;var i=c;a.font=i+"px sans-serif";var j=a.measureText(Y).width,k=j+b,l=.7*i+b,m=C.width-(2*c+2*b)-k,n=C.height-l-b,o=m+.5*b,p=C.height-1.5*b;a.fillStyle="#000000",h(a,m,n,k,l,8,!0,!1),a.fillStyle="#ffffff",a.fillText(Y,o,p),a.restore()}}function h(a,b,c,d,e,f,g,h){f="number"==typeof f?f:5,g="boolean"==typeof g?g:!0,h="boolean"==typeof h?h:!1,a.beginPath(),a.moveTo(b+f,c),a.lineTo(b+d-f,c),a.quadraticCurveTo(b+d,c,b+d,c+f),a.lineTo(b+d,c+e-f),a.quadraticCurveTo(b+d,c+e,b+d-f,c+e),a.lineTo(b+f,c+e),a.quadraticCurveTo(b,c+e,b,c+e-f),a.lineTo(b,c+f),a.quadraticCurveTo(b,c,b+f,c),a.closePath(),g&&a.fill(),h&&a.stroke()}function i(a){var b={x:I.x>=C.width/G/2?I.x-C.width/G/2:0,y:I.y>=C.height/G/2?I.y-C.height/G/2:0},c={x:I.x>=C.width/G/2?0:C.width/2-I.x*G,y:I.y>=C.height/G/2?0:C.height/2-I.y*G},d={};return d.x=b.x+a.x/G-c.x/G,d.y=b.y+a.y/G-c.y/G,d}function j(a){return{x:(a.x+C.width/G/2-I.x)*G,y:(a.y+C.height/G/2-I.y)*G}}function k(a,b){var c=this,d=this.position={x:a,y:b};this.next=null,this.handleWidth=12,this.onClick=function(a){return K===J.SOLUTION_POINT_DELETE?(B.solution.deleteVertex(c),void(E=!0)):K===J.SOLUTION_DRAW&&a.shiftKey&&null!==B.solution&&c.equals(B.solution.initialVertex)?(B.solution.close(),void(K=J.DEFAULT)):void 0},this.onMouseDown=function(){return K===J.SOLUTION_MOVE?(Z=d,$=!0,!0):!1}}function l(a){this.initialVertex=a||null}function m(){var a="#0000ff";return db&&(a=null!==B.solution&&B.solution.isWithinBounds(B.target.x,B.target.y)?"#00ff00":"#ff0000"),a}function n(a){a.save();var b=1.5,c=j(B.target);a.translate(c.x,c.y),a.scale(b*G,b*G),a.shadowColor="#ffffff",a.shadowBlur=5,w(a,"",m(),0,0,50),a.restore()}function o(){var a=null!==B.solution?B.solution.getVertices():[];return X.concat(a)}function p(a){var b=C.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top},d=o().filter(function(a){return a.isWithinBounds(c.x,c.y)});return d.length>0?d[0]:null}function q(a){if(0===a.button){var b=p(a);null!==b&&b.onMouseDown(a)||($=!0)}}function r(a){0===a.button&&(Z=I,$=!1)}function s(a){if(0===a.button){var b=p(a);if(null!==b)b.onClick(a);else{var c=C.getBoundingClientRect(),d={x:a.clientX-c.left,y:a.clientY-c.top};if(K===J.TARGET_DRAW&&(B.target=i(d),E=!0),K===J.SOLUTION_DRAW){if(a.shiftKey)null!==B.solution&&(B.solution.close(),K=J.DEFAULT);else{var e=i(d),f=new k(e.x,e.y);null===B.solution&&(B.solution=new l),B.solution.addVertex(f)}E=!0}}}}function t(a){a||(a=event),a.preventDefault(),a.detail<0||a.wheelDelta>0?B.zoomOut():B.zoomIn()}function u(a){var b=C.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top};if(null!==_&&$){var d=c.x-_.x,e=c.y-_.y;Z===I?(Z.x-=d/G,Z.y-=e/G):(Z.x+=d/G,Z.y+=e/G),E=!0}else{var f=p(a),g=Y;Y=null!==f&&"undefined"!=typeof f.tooltip?f.tooltip:null,g!==Y&&(E=!0)}_=c}function v(a,b){this.drawPosition=null,this.drawRadius=0,this.alpha=.5,this.color="#000000",this.icon=a,this.iconColor="#ffffff",this.tooltip=b||null,this.enabled=!1,this.enabledAlpha=.7,this.onClick=function(){alert("no click action set!")},this.onMouseDown=function(){return!1}}function w(a,b,c,d,e,f){a.font=f+"px FontAwesome",a.fillStyle=c;var g=a.measureText(b),h=d-g.width/2,i=e+.7*f/2;a.fillText(b,h,i)}function x(a,b,c){a.addEventListener(b,c),L.push({eventTarget:a,eventType:b,listener:c})}function y(){var a,b,c=L.slice();for(a=0;a<c.length;a++)b=c[a],b.eventTarget.removeEventListener(b.eventType,b.listener);L=[]}function z(){x(document,"mousedown",q),x(document,"mouseup",r),x(C,"DOMMouseScroll",t),x(C,"mousewheel",t),x(C,"mousemove",u),x(C,"click",s)}function A(){B.image.addEventListener("load",e,!1),B.image.src=c,"[object Array]"===Object.prototype.toString.call(d.solution)&&B.importSolution(d.solution),M.onClick=function(){B.zoomOut()},N.onClick=function(){B.zoomIn()},ab&&(P.onClick=function(){B.target=null,E=!0},Q.enabled=function(){return K===J.TARGET_DRAW},Q.onClick=function(){K=K===J.TARGET_DRAW?J.DEFAULT:J.TARGET_DRAW,E=!0},X=O.concat(R)),cb&&(S.enabled=function(){return K===J.SOLUTION_DRAW},S.onClick=function(){K=K===J.SOLUTION_DRAW?J.DEFAULT:J.SOLUTION_DRAW,E=!0},T.enabled=function(){return K===J.SOLUTION_MOVE},T.onClick=function(){K=K===J.SOLUTION_MOVE?J.DEFAULT:J.SOLUTION_MOVE,E=!0},U.enabled=function(){return K===J.SOLUTION_POINT_DELETE},U.onClick=function(){K=K===J.SOLUTION_POINT_DELETE?J.DEFAULT:J.SOLUTION_POINT_DELETE,E=!0},V.onClick=function(){B.solution=null,E=!0},X=O.concat(W)),z()}var B=this;d="object"==typeof d?d:{};var C=document.getElementById(b),D=C.getContext("2d"),E=!0,F=!1,G=1,H=.1,I={x:0,y:0},J={DEFAULT:0,TARGET_DRAW:1,SOLUTION_DRAW:2,SOLUTION_MOVE:3,SOLUTION_POINT_DELETE:4},K=J.DEFAULT,L=[],M=new v("","Zoom out"),N=new v("","Zoom in"),O=[M,N],P=new v("","Delete target"),Q=new v("","Set target"),R=[P,Q],S=new v("","Draw new solution point (close with shift-click)"),T=new v("","Move solution point"),U=new v("","Delete solution point"),V=new v("","Delete solution"),W=[V,U,T,S],X=O.slice(),Y=null,Z=I,$=!1,_=null,ab="string"==typeof d.mode&&"editTarget"===d.mode,bb=ab||"string"==typeof d.mode&&"showSolution"===d.mode,cb="string"==typeof d.mode&&"editSolution"===d.mode,db=cb||"string"==typeof d.mode&&"showSolution"===d.mode;this.image=new Image,this.target="object"==typeof d.target&&null!==d.target?d.target:null,this.solution=null,this.exportSolution=function(){if(null===this.solution)return[];var a=[],b=this.solution.getVertices();b[b.length-1].next===b[0]&&b.push(b[0]);for(var c=0;c<b.length;c++)a.push({x:b[c].position.x,y:b[c].position.y});return a},this.importSolution=function(a){if(a.length<1)return void(this.solution=null);for(var b=new k(a[0].x,a[0].y),c=b,d=null,e=1;e<a.length;e++){if(d=new k(a[e].x,a[e].y),d.equals(b)){c.next=b;break}c.next=d,c=d}this.solution=new l(b),E=!0},this.zoomIn=function(){G*=1+H,E=!0},this.zoomOut=function(){G*=1-H,E=!0},k.prototype.equals=function(a){return this.position.x===a.position.x&&this.position.y===a.position.y},k.prototype.isWithinBounds=function(a,b){var c=j(this.position);return a>=c.x-this.handleWidth/2&&a<=c.x+this.handleWidth/2&&b>=c.y-this.handleWidth/2&&b<=c.y+this.handleWidth/2},k.prototype.drawHandle=function(a){a.save();var b=j(this.position);a.translate(b.x,b.y),a.fillStyle="#FFFFFF",a.strokeStyle="#000000",a.beginPath(),a.rect(-this.handleWidth/2,-this.handleWidth/2,this.handleWidth,this.handleWidth),a.stroke(),a.fill(),a.restore()},l.prototype.addVertex=function(a){if(null!==this.initialVertex){for(var b=this.initialVertex;null!==b.next&&b.next!==this.initialVertex;)b=b.next;b.next=a}else this.initialVertex=a;E=!0},l.prototype.deleteVertex=function(a){if(null!==this.initialVertex&&this.initialVertex.equals(a))this.initialVertex=this.initialVertex.next;else for(var b=!1,c=this.initialVertex,d=c.next;!b&&null!==d&&d!==this.initialVertex;)d.equals(a)?(c.next=d.next,b=!0):(c=d,d=c.next)},l.prototype.getVertices=function(){for(var a=[],b=this.initialVertex;null!==b;)-1===a.indexOf(b)&&a.push(b),b=b.next!==this.initialVertex?b.next:null;return a},l.prototype.draw=function(a){if(null!==this.initialVertex&&null!==this.initialVertex.next){var b,c={x:0,y:0},d=this.initialVertex,e=j(this.initialVertex.position);a.save(),a.globalAlpha=.7,a.translate(e.x,e.y),a.scale(G,G),a.beginPath(),a.moveTo(c.x,c.y);do b=d.next,c={x:c.x+(b.position.x-d.position.x),y:c.y+(b.position.y-d.position.y)},a.lineTo(c.x,c.y),d=b;while(null!==d.next&&d!==this.initialVertex);a.fillStyle="#0000FF",d===this.initialVertex&&(a.closePath(),a.fill()),a.stroke(),a.restore()}cb&&this.getVertices().forEach(function(b){b.drawHandle(a)})},l.prototype.isWithinBounds=function(a,b){var c=this.getVertices();if(c[c.length-1].next!==c[0])return!1;for(var d=0,e=c.length-1,f=!1;d<c.length;e=d++)c[d].position.y>b!=c[e].position.y>b&&a<(c[e].position.x-c[d].position.x)*(b-c[d].position.y)/(c[e].position.y-c[d].position.y)+c[d].position.x&&(f=!f);return f},l.prototype.close=function(){this.getVertices().length>2&&this.addVertex(this.initialVertex)},v.prototype.isWithinBounds=function(a,b){if(null===this.drawPosition)return!1;var c=Math.abs(this.drawPosition.x-a),d=Math.abs(this.drawPosition.y-b);return c*c+d*d<=this.drawRadius*this.drawRadius},v.prototype.draw=function(a,b,c,d){this.drawPosition={x:b,y:c},this.drawRadius=d,a.save();var e="function"==typeof this.enabled?this.enabled():this.enabled;a.globalAlpha=e?this.enabledAlpha:this.alpha,a.fillStyle=this.color,a.lineWidth=0,a.beginPath(),a.arc(b,c,d,0,2*Math.PI),a.closePath(),a.fill(),a.save(),a.globalCompositeOperation="destination-out",w(a,this.icon,this.iconColor,b,c,d),a.restore(),a.restore()},this.dispose=function(){y(),F=!0},this.refresh=function(){B.dirty=!0},A()}a.ImageViewer=b}(window);